---
title: "Supplementary Material"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Supplementary Material}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message = FALSE}
library(ggplot2)
library(plotly)
library(dplyr)
library(colorspace)
library(dittoSeq)
library(tidySingleCellExperiment)
library(tidygate)
```


The gamma delta T cells (the blue cluster on the left with high signature score) could be interactively selected from the plot using the tidygate package.

```{r eval=FALSE}

sce_obj |>


  join_features(
    features = c("CD3D", "TRDC", "TRGC1", "TRGC2", "CD8A", "CD8B" ), shape = "wide"
  ) |>

  mutate(signature_score =
           scales::rescale(CD3D + TRDC + TRGC1+ TRGC2, to=c(0,1)) -
           scales::rescale(CD8A + CD8B, to=c(0,1))
  ) |>

  mutate(gate = gate_int(
    UMAP_1, UMAP_2,
    .size = 0.1,
    .color =signature_score
  ))

```

After the selection we can reload from file the gate drawn for reproducibility.

```{r eval=FALSE}

sce_obj |>

  join_features(
    features = c("CD3D", "TRDC", "TRGC1", "TRGC2", "CD8A", "CD8B" ), shape = "wide"

  ) |>

  mutate(signature_score =
           scales::rescale(CD3D + TRDC + TRGC1+ TRGC2, to=c(0,1)) -
           scales::rescale(CD8A + CD8B, to=c(0,1))
  ) |>

  mutate(gate = gate_int(
    UMAP_1, UMAP_2,
    .size = 0.1,
    .color =signature_score,
    gate_list = bioc2022tidytranscriptomics::gate_sce_obj
  ))

```

And the dataset could be filtered for just these cells using tidyverse `filter`.

```{r eval=FALSE}

sce_obj |>


  join_features(
    features = c("CD3D", "TRDC", "TRGC1", "TRGC2", "CD8A", "CD8B" ), shape = "wide"

  ) |>

  mutate(signature_score =
           scales::rescale(CD3D + TRDC + TRGC1+ TRGC2, to=c(0,1)) -
           scales::rescale(CD8A + CD8B, to=c(0,1))
  ) |>

  mutate(gate = gate_int(UMAP_1, UMAP_2, gate_list = bioc2022tidytranscriptomics::gate_sce_obj)) |>

  filter(gate == 1)
```

It was then possible to perform analyses on these gamma delta T cells by simply chaining further commands, such as below.

```{r eval = FALSE}

sce_obj |>


  join_features(
    features = c("CD3D", "TRDC", "TRGC1", "TRGC2", "CD8A", "CD8B"),   shape = "wide"

  ) |>

  mutate(signature_score =
           scales::rescale(CD3D + TRDC + TRGC1+ TRGC2, to=c(0,1)) -
           scales::rescale(CD8A + CD8B, to=c(0,1))
  ) |>

  mutate( gate = gate_int(UMAP_1, UMAP_2, gate_list = bioc2022tidytranscriptomics::gate_sce_obj) ) |>

  filter(gate == 1) |>

  # Reanalyse
  NormalizeData(assay="RNA") |>
  FindVariableFeatures( nfeatures = 100, assay="RNA") |>
  SplitObject(split.by = "file") |>
  RunFastMNN(assay="RNA") |>
  RunUMAP(reduction = "mnn", dims = 1:20) |>
  FindNeighbors( dims = 1:20, reduction = "mnn") |>
  FindClusters( resolution = 0.3)
```

For comparison, we show the alternative using base R and SingleCellExperiment

```{r eval = FALSE}

counts_positive =
  GetAssayData(sce_obj, assay="SCT")[c("CD3D", "TRDC", "TRGC1", "TRGC2"),] |>
  colSums() |>
  scales::rescale(to=c(0,1))

counts_negative =
  GetAssayData(sce_obj, assay="SCT")[c("CD8A", "CD8B"),] |>
  colSums()  |>
  scales::rescale(to=c(0,1))

sce_obj$signature_score = counts_positive - counts_negative

p = FeaturePlot(sce_obj, features = "signature_score")

# This is not reproducible (in contrast to tidygate)
sce_obj$within_gate = colnames(sce_obj) %in% CellSelector(plot = p)

sce_obj |>
  subset(within_gate == TRUE) |>

  # Reanalyse
  NormalizeData(assay="RNA") |>
  FindVariableFeatures( nfeatures = 100, assay="RNA") |>
  SplitObject(split.by = "file") |>
  RunFastMNN(assay="RNA") |>
  RunUMAP(reduction = "mnn", dims = 1:20) |>
  FindNeighbors( dims = 1:20, reduction = "mnn") |>
  FindClusters( resolution = 0.3)
```

